-- 자동차 평균 대여 기간 구하기
SELECT
CAR_ID , 
ROUND(AVG(datediff(end_date,start_date)+1),1) AS AVERAGE_DURATION
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
GROUP BY CAR_ID
HAVING ROUND(AVG(datediff(end_date,start_date)+1),1) >=7
ORDER BY 2 DESC , 1 DESC

-- 조회수가 가장 많은 중고거래 게시판의 첨부파일 조회하기
WITH TOP_VIEW AS(
    SELECT 
    BOARD_ID 
    FROM USED_GOODS_BOARD 
    ORDER BY VIEWS DESC
    LIMIT 1
)

SELECT 
CONCAT('/home/grep/src/',BOARD_ID,'/',FILE_ID,FILE_NAME,FILE_EXT) AS FILE_PATH
FROM USED_GOODS_FILE 
WHERE BOARD_ID = (SELECT * FROM TOP_VIEW)
ORDER BY 1 DESC

-- 조건에 부합하는 중고거래 상태 조회하기
SELECT
BOARD_ID,
WRITER_ID,
TITLE,
PRICE,
CASE
    WHEN STATUS = 'SALE' THEN '판매중'
    WHEN STATUS = 'DONE' THEN '거래완료'
    ELSE '예약중'
    END AS STATUS
FROM USED_GOODS_BOARD 
WHERE CREATED_DATE = '2022-10-05'
ORDER BY 1 DESC 

-- 자동차 대여 기록 별 대여 금액 구하기
WITH CT_TRUCK AS(
    SELECT
    CAR_ID , CAR_TYPE , DAILY_FEE
    FROM CAR_RENTAL_COMPANY_CAR 
    WHERE CAR_TYPE = '트럭'
),
DISCOUNT AS(
    SELECT (100-DISCOUNT_RATE)/100 AS DISCOUNT , DURATION_TYPE
    FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN 
    WHERE CAR_TYPE ='트럭'
)
SELECT 
HISTORY_ID,
CASE
    WHEN DATEDIFF(END_DATE,START_DATE)+1 >=90 THEN ROUND(((DATEDIFF(END_DATE,START_DATE)+1)*DAILY_FEE)*(SELECT DISCOUNT FROM DISCOUNT WHERE DURATION_TYPE ='90일 이상'))
    WHEN DATEDIFF(END_DATE,START_DATE)+1 >=30 THEN ROUND(((DATEDIFF(END_DATE,START_DATE)+1)*DAILY_FEE)*(SELECT DISCOUNT FROM DISCOUNT WHERE DURATION_TYPE ='30일 이상'))
    WHEN DATEDIFF(END_DATE,START_DATE)+1 >=7 THEN ROUND(((DATEDIFF(END_DATE,START_DATE)+1)*DAILY_FEE)*(SELECT DISCOUNT FROM DISCOUNT WHERE DURATION_TYPE ='7일 이상'))
    ELSE ROUND(((DATEDIFF(END_DATE,START_DATE)+1)*DAILY_FEE))
    END AS FEE
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY CRCRH JOIN CT_TRUCK TRUCK
USING(CAR_ID)
WHERE TRUCK.CAR_TYPE IS NOT NULL
ORDER BY 2 DESC , 1 DESC

-- 특정 옵션이 포함된 자동차 리스트 구하기
SELECT
*
FROM CAR_RENTAL_COMPANY_CAR 
WHERE OPTIONS LIKE '%네비게이션%'
ORDER BY CAR_ID DESC

-- 자동차 대여 기록에서 장기/단기 대여 구분하기
SELECT
HISTORY_ID,
CAR_ID,
DATE_FORMAT(START_DATE,'%Y-%m-%d') AS START_DATE,
DATE_FORMAT(END_DATE,'%Y-%m-%d') AS END_DATE,
CASE
    WHEN DATEDIFF(END_DATE,START_DATE)+1 >= 30 THEN '장기 대여'
    ELSE '단기 대여'
    END AS RENT_TYPE
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY 
WHERE START_DATE LIKE '2022-09%'
ORDER BY HISTORY_ID DESC

-- 조건별로 분류하여 주문상태 출력하기
SELECT
ORDER_ID,
PRODUCT_ID,
DATE_FORMAT(OUT_DATE,'%Y-%m-%d')AS OUT_DATE,
CASE 
    WHEN OUT_DATE <='2022-05-01' THEN '출고완료'
    WHEN OUT_DATE IS NULL THEN '출고미정'
    ELSE '출고대기'
    END AS '출고여부'
FROM FOOD_ORDER 
ORDER BY 1

-- 대여 기록이 존재하는 자동차 리스트 구하기
WITH CAR_ID AS(
    SELECT
    CAR_ID
    FROM CAR_RENTAL_COMPANY_CAR 
    WHERE CAR_TYPE = '세단'
)

SELECT 
DISTINCT CAR_ID
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
WHERE CAR_ID IN (SELECT * FROM CAR_ID)
AND START_DATE LIKE '2022-10%'
ORDER BY 1 DESC

-- 조건에 맞는 사용자 정보 조회하기
SELECT 
USER_ID,
NICKNAME,
concat(city,' ',street_address1,' ',street_address2) AS 전체주소,
concat(LEFT(tlno,3), '-', MID(tlno,4,4),'-', RIGHT(tlno,4)) AS 전화번호
FROM USED_GOODS_USER 
WHERE USER_ID IN (SELECT WRITER_ID
FROM USED_GOODS_BOARD 
GROUP BY WRITER_ID
HAVING COUNT(*)>=3)
ORDER BY 1 DESC

-- 취소되지 않은 진료 예약 조회하기
WITH RESULT AS(
    SELECT
    *
    FROM APPOINTMENT 
    WHERE MCDP_CD = 'CS'
    AND APNT_CNCL_YMD IS NULL
    AND APNT_YMD LIKE '2022-04-13%'

)

SELECT
APNT_NO , PT_NAME ,PT.PT_NO, DT.MCDP_CD , DR_NAME , APNT_YMD
FROM RESULT RES JOIN DOCTOR DT
ON RES.MDDR_ID = DT.DR_ID
JOIN PATIENT PT
USING(PT_NO)
ORDER BY 6

-- 루시와 엘라 찾기
SELECT 
ANIMAL_ID,
NAME,
SEX_UPON_INTAKE
FROM ANIMAL_INS 
WHERE NAME IN ('Lucy', 'Ella', 'Pickle', 'Rogan', 'Sabrina', 'Mitty')
ORDER BY 1

-- 이름에 el이 들어가는 동물 찾기
SELECT
ANIMAL_ID,
NAME
FROM ANIMAL_INS
WHERE ANIMAL_TYPE = 'Dog'
AND NAME LIKE '%EL%'
ORDER BY 2

-- 중성화 여부 파악하기
SELECT
ANIMAL_ID,
NAME,
CASE 
    WHEN SEX_UPON_INTAKE LIKE 'Intact%' THEN 'X'
    ELSE 'O'
    END AS '중성화'
FROM ANIMAL_INS

-- 오랜 기간 보호한 동물(2)
WITH GOODBYE_DOG AS (
    SELECT
    AI.ANIMAL_ID , AI.NAME , DATEDIFF(AO.DATETIME,AI.DATETIME)
    FROM ANIMAL_INS AI JOIN ANIMAL_OUTS AO
    USING(ANIMAL_ID)
    ORDER BY 3 DESC 
)

SELECT
ANIMAL_ID , NAME
FROM GOODBYE_DOG
LIMIT 2

-- 카테고리 별 상품 개수 구하기
SELECT
LEFT(PRODUCT_CODE,2) AS CATEGORY,
COUNT(*) AS PRODUCTS
FROM PRODUCT
GROUP BY LEFT(PRODUCT_CODE,2)

-- DATETIME에서 DATE로 형 변환
SELECT
ANIMAL_ID,
NAME,
DATE_FORMAT(DATETIME,'%Y-%m-%d') AS '날짜'
FROM ANIMAL_INS

-- 연도 별 평균 미세먼지 농도 조회하기
SELECT
YEAR(YM) AS 'YEAR',
ROUND(AVG(PM_VAL1),2) AS 'PM10',
ROUND(AVG(PM_VAL2),2) AS 'PM2.5'
FROM AIR_POLLUTION 
WHERE LOCATION2 = '수원'
GROUP BY 1
ORDER BY 1

-- 한 해에 잡은 물고기 수 구하기
SELECT
COUNT(*) AS FISH_COUNT
FROM FISH_INFO
WHERE YEAR(TIME) ='2021'

-- 분기별 분화된 대장균의 개체 수 구하기
WITH QUARTER_LIST AS (
    SELECT
    CASE 
        WHEN MONTH(DIFFERENTIATION_DATE) BETWEEN 1 AND 3 THEN '1Q'
        WHEN MONTH(DIFFERENTIATION_DATE) BETWEEN 4 AND 6 THEN '2Q'
        WHEN MONTH(DIFFERENTIATION_DATE) BETWEEN 7 AND 9 THEN '3Q'
        ELSE '4Q'
        END AS QUARTER
    FROM ECOLI_DATA 
)

SELECT
QUARTER ,
COUNT(*) AS ECOLI_COUNT
FROM QUARTER_LIST
GROUP BY 1
ORDER BY 1